{
  "id": "binary_exploitation_296af1af5313",
  "category": "binary-exploitation",
  "title": "freebsd ptrace rfi vm map prot exec bypass ps5",
  "description": "# FreeBSD ptrace RFI and vm_map PROT_EXEC bypass (PS5 case study)\n\n{{#include ../banners/hacktricks-training.md}}\n\n## Overview\n\nThis page documents a practical Unix/BSD usermode process/ELF injection technique on PlayStation 5 (PS5), which is based on FreeBSD. The method generalizes to FreeBSD derivatives when you already have kernel read/write (R/W) primitives. High level:\n\n- Patch the current process credentials (ucred) to grant debugger authority, enabling ptrace/mdbg on arbitrary user proces",
  "payloads": [
    "# FreeBSD ptrace RFI and vm_map PROT_EXEC bypass (PS5 case study)",
    "{{#include ../banners/hacktricks-training.md}}",
    "## Overview",
    "This page documents a practical Unix/BSD usermode process/ELF injection technique on PlayStation 5 (PS5), which is based on FreeBSD. The method generalizes to FreeBSD derivatives when you already have kernel read/write (R/W) primitives. High level:",
    "- Patch the current process credentials (ucred) to grant debugger authority, enabling ptrace/mdbg on arbitrary user processes.",
    "- Find target processes by walking the kernel allproc list.",
    "- Bypass PROT_EXEC restrictions by flipping vm_map_entry.protection |= PROT_EXEC in the target\u2019s vm_map via kernel data writes.",
    "- Use ptrace to perform Remote Function Invocation (RFI): suspend a thread, set registers to call arbitrary functions inside the target, resume, collect return values, and restore state.",
    "- Map and run arbitrary ELF payloads inside the target using an in-process ELF loader, then spawn a dedicated thread that runs your payload and triggers a breakpoint to detach cleanly.",
    "PS5 hypervisor mitigations worth noting (contextualized for this technique):",
    "- XOM (execute-only .text) prevents reading/writing kernel .text.",
    "- Clearing CR0.WP or disabling CR4.SMEP causes a hypervisor vmexit (crash). Only data-only kernel writes are viable.",
    "- Userland mmap is restricted to PROT_READ|PROT_WRITE by default. Granting PROT_EXEC must be done by editing vm_map entries in kernel memory.",
    "This technique is post-exploitation: it assumes kernel R/W primitives from an exploit chain. Public payloads demonstrate this up to firmware 10.01 at time of writing.",
    "## Kernel data-only primitives"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/freebsd-ptrace-rfi-vm_map-prot_exec-bypass-ps5.md"
  ]
}