{
  "id": "binary_exploitation_4c5614d712c9",
  "category": "binary-exploitation",
  "title": "ret2esp ret2reg",
  "description": "# Ret2esp / Ret2reg\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## **Ret2esp**\n\n**Because the ESP (Stack Pointer) always points to the top of the stack**, this technique involves replacing the EIP (Instruction Pointer) with the address of a **`jmp esp`** or **`call esp`** instruction. By doing this, the shellcode is placed right after the overwritten EIP. When the `ret` instruction executes, ESP points to the next address, precisely where the shellcode is stored.\n\nIf **Address Space Layo",
  "payloads": [
    "# Ret2esp / Ret2reg",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## **Ret2esp**",
    "**Because the ESP (Stack Pointer) always points to the top of the stack**, this technique involves replacing the EIP (Instruction Pointer) with the address of a **`jmp esp`** or **`call esp`** instruction. By doing this, the shellcode is placed right after the overwritten EIP. When the `ret` instruction executes, ESP points to the next address, precisely where the shellcode is stored.",
    "If **Address Space Layout Randomization (ASLR)** is not enabled in Windows or Linux, it's possible to use `jmp esp` or `call esp` instructions found in shared libraries. However, with [**ASLR**](../common-binary-protections-and-bypasses/aslr/index.html) active, one might need to look within the vulnerable program itself for these instructions (and you might need to defeat [**PIE**](../common-binary-protections-and-bypasses/pie/index.html)).",
    "Moreover, being able to place the shellcode **after the EIP corruption**, rather than in the middle of the stack, ensures that any `push` or `pop` instructions executed during the function's operation don't interfere with the shellcode. This interference could happen if the shellcode were placed in the middle of the function's stack.",
    "### Lacking space",
    "If you are lacking space to write after overwriting RIP (maybe just a few bytes), write an initial **`jmp`** shellcode like:",
    "```armasm",
    "sub rsp, 0x30",
    "jmp rsp",
    "And write the shellcode early in the stack.",
    "### Example",
    "You can find an example of this technique in [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) with a final exploit like:",
    "```python"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/rop-return-oriented-programing/ret2esp-ret2reg.md"
  ]
}