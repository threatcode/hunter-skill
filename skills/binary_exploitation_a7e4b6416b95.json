{
  "id": "binary_exploitation_a7e4b6416b95",
  "category": "binary-exploitation",
  "title": "windows vectored overloading",
  "description": "# Vectored Overloading PE Injection\n\n{{#include ../banners/hacktricks-training.md}}\n\n## Technique overview\n\nVectored Overloading is a **Windows PE injection primitive** that fuses classic [Module Overloading](https://github.com/hasherezade/module_overloading) with **Vectored Exception Handlers (VEHs)** and **hardware breakpoints**. Instead of patching `LoadLibrary` or writing its own loader, the adversary:\n\n1. Creates a `SEC_IMAGE` section backed by a legitimate DLL (e.g., `wmp.dll`).\n2. Overwri",
  "payloads": [
    "# Vectored Overloading PE Injection",
    "{{#include ../banners/hacktricks-training.md}}",
    "## Technique overview",
    "Vectored Overloading is a **Windows PE injection primitive** that fuses classic [Module Overloading](https://github.com/hasherezade/module_overloading) with **Vectored Exception Handlers (VEHs)** and **hardware breakpoints**. Instead of patching `LoadLibrary` or writing its own loader, the adversary:",
    "1. Creates a `SEC_IMAGE` section backed by a legitimate DLL (e.g., `wmp.dll`).",
    "2. Overwrites the mapped view with a fully relocated malicious PE but keeps the section object pointing to the benign image on disk.",
    "3. Registers a VEH and programs debug registers so every call to `NtOpenSection`, `NtMapViewOfSection`, and optionally `NtClose` raises a user-mode breakpoint.",
    "4. Calls `LoadLibrary(\"amsi.dll\")` (or any other benign target). When the Windows loader invokes those syscalls, the VEH **skips the kernel transition** and returns the handles and base addresses of the prepared malicious image.",
    "Because the loader still believes it mapped the requested DLL, tooling that only looks at section backing files sees `wmp.dll` even though memory now contains the attacker\u2019s payload. Meanwhile, imports/TLS callbacks are still resolved by the genuine loader, significantly reducing the amount of custom PE-parsing logic the adversary must maintain.",
    "## Stage 1 \u2013 Build the disguised section",
    "1. **Create and map a section for the decoy DLL**",
    "NtCreateSection(&DecoySection, SECTION_ALL_ACCESS, NULL,",
    "0, PAGE_READWRITE, SEC_IMAGE, L\"\\??\\C:\\\\Windows\\\\System32\\\\wmp.dll\");",
    "NtMapViewOfSection(DecoySection, GetCurrentProcess(), &DecoyView, 0, 0,",
    "NULL, &DecoySize, ViewShare, 0, PAGE_READWRITE);"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/windows-vectored-overloading.md"
  ]
}