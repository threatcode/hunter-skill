{
  "id": "pentesting_web_4605cb79378a",
  "category": "pentesting-web",
  "title": "h2c smuggling",
  "description": "# Upgrade Header Smuggling\n\n{{#include ../banners/hacktricks-training.md}}\n\n### H2C Smuggling <a href=\"#http2-over-cleartext-h2c\" id=\"http2-over-cleartext-h2c\"></a>\n\n#### HTTP2 Over Cleartext (H2C) <a href=\"#http2-over-cleartext-h2c\" id=\"http2-over-cleartext-h2c\"></a>\n\nH2C, or **http2 over cleartext**, deviates from the norm of transient HTTP connections by upgrading a standard HTTP **connection to a persistent one**. This upgraded connection utilizes the http2 binary protocol for ongoing commun",
  "payloads": [
    "# Upgrade Header Smuggling",
    "{{#include ../banners/hacktricks-training.md}}",
    "### H2C Smuggling <a href=\"#http2-over-cleartext-h2c\" id=\"http2-over-cleartext-h2c\"></a>",
    "#### HTTP2 Over Cleartext (H2C) <a href=\"#http2-over-cleartext-h2c\" id=\"http2-over-cleartext-h2c\"></a>",
    "H2C, or **http2 over cleartext**, deviates from the norm of transient HTTP connections by upgrading a standard HTTP **connection to a persistent one**. This upgraded connection utilizes the http2 binary protocol for ongoing communication, as opposed to the single-request nature of plaintext HTTP.",
    "The crux of the smuggling issue arises with the usage of a **reverse proxy**. Ordinarily, the reverse proxy processes and forwards HTTP requests to the backend, returning the backend's response after that. However, when the `Connection: Upgrade` header is present in an HTTP request (commonly seen with websocket connections), the reverse **proxy maintains a persistent connection** between client and server, facilitating the continuous exchange required by certain protocols. For H2C connections, adherence to the RFC necessitates the presence of three specific headers:",
    "Upgrade: h2c",
    "HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA",
    "Connection: Upgrade, HTTP2-Settings",
    "The vulnerability arises when, after upgrading a connection, the reverse proxy ceases to manage individual requests, assuming its job of routing is complete post-connection establishment. Exploiting H2C Smuggling allows for circumvention of reverse proxy rules applied during request processing, such as path-based routing, authentication, and WAF processing, assuming an H2C connection is successfully initiated.",
    "#### Vulnerable Proxies <a href=\"#exploitation\" id=\"exploitation\"></a>",
    "The vulnerability is contingent on the reverse proxy's handling of `Upgrade` and sometimes `Connection` headers. The following proxies inherently forward these headers during proxy-pass, thereby inherently enabling H2C smuggling:",
    "- HAProxy",
    "- Traefik",
    "- Nuster"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/pentesting-web/h2c-smuggling.md"
  ]
}