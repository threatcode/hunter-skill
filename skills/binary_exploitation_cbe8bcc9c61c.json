{
  "id": "binary_exploitation_cbe8bcc9c61c",
  "category": "binary-exploitation",
  "title": "libc protections",
  "description": "# Libc Protections\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Chunk Alignment Enforcement\n\n**Malloc** allocates memory in **8-byte (32-bit) or 16-byte (64-bit) groupings**. This means the end of chunks in 32-bit systems should align with **0x8**, and in 64-bit systems with **0x0**. The security feature checks that each chunk **aligns correctly** at these specific locations before using a pointer from a bin.\n\n### Security Benefits\n\nThe enforcement of chunk alignment in 64-bit systems ",
  "payloads": [
    "# Libc Protections",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Chunk Alignment Enforcement",
    "**Malloc** allocates memory in **8-byte (32-bit) or 16-byte (64-bit) groupings**. This means the end of chunks in 32-bit systems should align with **0x8**, and in 64-bit systems with **0x0**. The security feature checks that each chunk **aligns correctly** at these specific locations before using a pointer from a bin.",
    "### Security Benefits",
    "The enforcement of chunk alignment in 64-bit systems significantly enhances Malloc's security by **limiting the placement of fake chunks to only 1 out of every 16 addresses**. This complicates exploitation efforts, especially in scenarios where the user has limited control over input values, making attacks more complex and harder to execute successfully.",
    "- **Fastbin Attack on \\_\\_malloc_hook**",
    "The new alignment rules in Malloc also thwart a classic attack involving the `__malloc_hook`. Previously, attackers could manipulate chunk sizes to **overwrite this function pointer** and gain **code execution**. Now, the strict alignment requirement ensures that such manipulations are no longer viable, closing a common exploitation route and enhancing overall security.",
    "## Pointer Mangling on fastbins and tcache",
    "**Pointer Mangling** is a security enhancement used to protect **fastbin and tcache Fd pointers** in memory management operations. This technique helps prevent certain types of memory exploit tactics, specifically those that do not require leaked memory information or that manipulate memory locations directly relative to known positions (relative **overwrites**).",
    "The core of this technique is an obfuscation formula:",
    "**`New_Ptr = (L >> 12) XOR P`**",
    "- **L** is the **Storage Location** of the pointer.",
    "- **P** is the actual **fastbin/tcache Fd Pointer**.",
    "The reason for the bitwise shift of the storage location (L) by 12 bits to the right before the XOR operation is critical. This manipulation addresses a vulnerability inherent in the deterministic nature of the least significant 12 bits of memory addresses, which are typically predictable due to system architecture constraints. By shifting the bits, the predictable portion is moved out of the equation, enhancing the randomness of the new, mangled pointer and thereby safeguarding against exploits that rely on the predictability of these bits."
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/common-binary-protections-and-bypasses/libc-protections.md"
  ]
}