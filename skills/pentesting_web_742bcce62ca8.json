{
  "id": "pentesting_web_742bcce62ca8",
  "category": "pentesting-web",
  "title": "cloud ssrf",
  "description": "# Cloud SSRF\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## AWS\n\n### Abusing SSRF in AWS EC2 environment\n\n**The metadata** endpoint can be accessed from inside any EC2 machine and offers interesting information about it. It's accesible in the url: `http://169.254.169.254` ([information about the metadata here](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)).\n\nThere are **2 versions** of the metadata endpoint. The **first** one allows to **access** the end",
  "payloads": [
    "# Cloud SSRF",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## AWS",
    "### Abusing SSRF in AWS EC2 environment",
    "**The metadata** endpoint can be accessed from inside any EC2 machine and offers interesting information about it. It's accesible in the url: `http://169.254.169.254` ([information about the metadata here](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)).",
    "There are **2 versions** of the metadata endpoint. The **first** one allows to **access** the endpoint via **GET** requests (so any **SSRF can exploit it**). For the **version 2**, [IMDSv2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html), you need to ask for a **token** sending a **PUT** request with a **HTTP header** and then use that token to access the metadata with another HTTP header (so it's **more complicated to abuse** with a SSRF).",
    "> [!CAUTION]",
    "> Note that if the EC2 instance is enforcing IMDSv2, [**according to the docs**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), the **response of the PUT request** will have a **hop limit of 1**, making impossible to access the EC2 metadata from a container inside the EC2 instance.",
    "> Moreover, **IMDSv2** will also **block requests to fetch a token that include the `X-Forwarded-For` header**. This is to prevent misconfigured reverse proxies from being able to access it.",
    "You can find information about the [metadata endpoints in the docs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-categories.html). In the following script some interesting information is obtained from it:",
    "```bash",
    "EC2_TOKEN=$(curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\" 2>/dev/null || wget -q -O - --method PUT \"http://169.254.169.254/latest/api/token\" --header \"X-aws-ec2-metadata-token-ttl-seconds: 21600\" 2>/dev/null)",
    "HEADER=\"X-aws-ec2-metadata-token: $EC2_TOKEN\"",
    "URL=\"http://169.254.169.254/latest/meta-data\"",
    "aws_req=\"\""
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.md"
  ]
}