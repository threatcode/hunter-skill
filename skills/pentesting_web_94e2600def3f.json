{
  "id": "pentesting_web_94e2600def3f",
  "category": "pentesting-web",
  "title": "lfi2rce via nginx temp files",
  "description": "# LFI2RCE via Nginx temp files\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Vulnerable configuration\n\n[Example from bierbaumer.net](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/) showed that even the following one-liner is enough when PHP runs behind an nginx reverse proxy that buffers request bodies to disk:\n\n```php\n<?php\n$action = $_GET['action'] ?? 'read';\n$path   = $_GET['file'] ?? 'index.php';\n$action === 'read' ? readfile($path) : include $path;\n```\n\nThe nginx si",
  "payloads": [
    "# LFI2RCE via Nginx temp files",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Vulnerable configuration",
    "[Example from bierbaumer.net](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/) showed that even the following one-liner is enough when PHP runs behind an nginx reverse proxy that buffers request bodies to disk:",
    "```php",
    "$action = $_GET['action'] ?? 'read';",
    "$path   = $_GET['file'] ?? 'index.php';",
    "$action === 'read' ? readfile($path) : include $path;",
    "The nginx side typically keeps default temp paths such as `/var/lib/nginx/body` and `/var/lib/nginx/fastcgi`. When a request body or upstream response is larger than the in-memory buffer (\u22488\u202fKB by default), nginx transparently writes the data to a temp file, keeps the file descriptor open, and only unlinks the file name. Any PHP `include` that follows symbolic links (like `/proc/<pid>/fd/<fd>`) can still execute the unlinked contents, giving you RCE through LFI.",
    "## Why nginx temp files are abusable",
    "* Request bodies that exceed the buffer threshold are flushed to `client_body_temp_path` (defaults to `/tmp/nginx/client-body` or `/var/lib/nginx/body`).",
    "* The file name is random, but the file descriptor remains reachable under `/proc/<nginx_pid>/fd/<fd>`. As long as the request body has not completed (or you keep the TCP stream hanging), nginx keeps the descriptor open even though the path entry is unlinked.",
    "* PHP\u2019s include/require resolves those `/proc/.../fd/...` symlinks, so an attacker with LFI can hop through procfs to execute the buffered temp file even after nginx deletes it.",
    "## Classic exploitation workflow (recap)",
    "1. **Enumerate worker PIDs.** Fetch `/proc/<pid>/cmdline` over the LFI until you find strings like `nginx: worker process`. The number of workers rarely exceeds the CPU count, so you only have to scan the lower PID space."
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/pentesting-web/file-inclusion/lfi2rce-via-nginx-temp-files.md"
  ]
}