{
  "id": "macos_hardening_ff873ffef4e3",
  "category": "macos-hardening",
  "title": "enrolling devices in other organisations",
  "description": "# Enrolling Devices in Other Organisations\n\n{{#include ../../../banners/hacktricks-training.md}}\n\n## Intro\n\nAs [**previously commented**](#what-is-mdm-mobile-device-management)**,** in order to try to enrol a device into an organization **only a Serial Number belonging to that Organization is needed**. Once the device is enrolled, several organizations will install sensitive data on the new device: certificates, applications, WiFi passwords, VPN configurations [and so on](https://developer.apple",
  "payloads": [
    "# Enrolling Devices in Other Organisations",
    "{{#include ../../../banners/hacktricks-training.md}}",
    "## Intro",
    "As [**previously commented**](#what-is-mdm-mobile-device-management)**,** in order to try to enrol a device into an organization **only a Serial Number belonging to that Organization is needed**. Once the device is enrolled, several organizations will install sensitive data on the new device: certificates, applications, WiFi passwords, VPN configurations [and so on](https://developer.apple.com/enterprise/documentation/Configuration-Profile-Reference.pdf).\\",
    "Therefore, this could be a dangerous entrypoint for attackers if the enrolment process isn't correctly protected.",
    "**The following is a summary of the research [https://duo.com/labs/research/mdm-me-maybe](https://duo.com/labs/research/mdm-me-maybe). Check it for further technical details!**",
    "## Overview of DEP and MDM Binary Analysis",
    "This research delves into the binaries associated with the Device Enrollment Program (DEP) and Mobile Device Management (MDM) on macOS. Key components include:",
    "- **`mdmclient`**: Communicates with MDM servers and triggers DEP check-ins on macOS versions before 10.13.4.",
    "- **`profiles`**: Manages Configuration Profiles, and triggers DEP check-ins on macOS versions 10.13.4 and later.",
    "- **`cloudconfigurationd`**: Manages DEP API communications and retrieves Device Enrollment profiles.",
    "DEP check-ins utilize the `CPFetchActivationRecord` and `CPGetActivationRecord` functions from the private Configuration Profiles framework to fetch the Activation Record, with `CPFetchActivationRecord` coordinating with `cloudconfigurationd` through XPC.",
    "## Tesla Protocol and Absinthe Scheme Reverse Engineering",
    "The DEP check-in involves `cloudconfigurationd` sending an encrypted, signed JSON payload to _iprofiles.apple.com/macProfile_. The payload includes the device's serial number and the action \"RequestProfileConfiguration\". The encryption scheme used is referred to internally as \"Absinthe\". Unraveling this scheme is complex and involves numerous steps, which led to exploring alternative methods for inserting arbitrary serial numbers in the Activation Record request.",
    "## Proxying DEP Requests"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/macos-hardening/macos-red-teaming/macos-mdm/enrolling-devices-in-other-organisations.md"
  ]
}