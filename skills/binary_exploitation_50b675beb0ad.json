{
  "id": "binary_exploitation_50b675beb0ad",
  "category": "binary-exploitation",
  "title": "arm64 static linear map kaslr bypass",
  "description": "# Linux arm64 Static Linear Map KASLR Bypass\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Overview\n\nAndroid kernels built for arm64 almost universally enable **`CONFIG_ARM64_VA_BITS=39`** (3-level paging) and **`CONFIG_MEMORY_HOTPLUG=y`**. With only 512 GiB of kernel virtual space available, the Linux developers chose to anchor the **linear map** at the lowest possible kernel VA so that future hot-plugged RAM can simply extend the mapping upward. Since commit `1db780bafa4c`, arm64 no l",
  "payloads": [
    "# Linux arm64 Static Linear Map KASLR Bypass",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Overview",
    "Android kernels built for arm64 almost universally enable **`CONFIG_ARM64_VA_BITS=39`** (3-level paging) and **`CONFIG_MEMORY_HOTPLUG=y`**. With only 512 GiB of kernel virtual space available, the Linux developers chose to anchor the **linear map** at the lowest possible kernel VA so that future hot-plugged RAM can simply extend the mapping upward. Since commit `1db780bafa4c`, arm64 no longer even attempts to randomize that placement, which means:",
    "- `PAGE_OFFSET = 0xffffff8000000000` is compiled in.",
    "- `PHYS_OFFSET` is sourced from the exported `memstart_addr`, which on stock Android devices is effectively constant (0x80000000 today).",
    "As a consequence, **every physical page has a deterministic linear-map virtual address that is independent of the KASLR slide**:",
    "#define phys_to_virt(p) (((unsigned long)(p) - 0x80000000UL) | 0xffffff8000000000UL)",
    "If an attacker can learn or influence a physical address (kernel object, PFN from `/proc/pagemap`, or even a user-controlled page), they instantly know the corresponding kernel virtual address without leaking the randomized primary kernel mapping.",
    "## Reading `memstart_addr` and confirming the transform",
    "`memstart_addr` is exported in `/proc/kallsyms` and can be read on rooted devices or via any arbitrary kernel-read primitive. Project Zero used Jann Horn's tracing-BPF helper (`bpf_arb_read`) to dump it directly:",
    "```bash",
    "grep memstart /proc/kallsyms",
    "# ... obtains memstart_addr virtual address",
    "./bpf_arb_read <addr_of_memstart_addr> 8"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/linux-kernel-exploitation/arm64-static-linear-map-kaslr-bypass.md"
  ]
}