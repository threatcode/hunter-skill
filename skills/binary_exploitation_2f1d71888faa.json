{
  "id": "binary_exploitation_2f1d71888faa",
  "category": "binary-exploitation",
  "title": "stack pivoting ebp2ret ebp chaining",
  "description": "# Stack Pivoting - EBP2Ret - EBP chaining\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Basic Information\n\nThis technique exploits the ability to manipulate the **Base Pointer (EBP/RBP)** to chain the execution of multiple functions through careful use of the frame pointer and the **`leave; ret`** instruction sequence.\n\nAs a reminder, on x86/x86-64 **`leave`** is equivalent to:\n\n```\nmov       rsp, rbp   ; mov esp, ebp on x86\npop       rbp        ; pop ebp on x86\nret\n```\n\nAnd as the save",
  "payloads": [
    "# Stack Pivoting - EBP2Ret - EBP chaining",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Basic Information",
    "This technique exploits the ability to manipulate the **Base Pointer (EBP/RBP)** to chain the execution of multiple functions through careful use of the frame pointer and the **`leave; ret`** instruction sequence.",
    "As a reminder, on x86/x86-64 **`leave`** is equivalent to:",
    "mov       rsp, rbp   ; mov esp, ebp on x86",
    "pop       rbp        ; pop ebp on x86",
    "And as the saved **EBP/RBP is in the stack** before the saved EIP/RIP, it's possible to control it by controlling the stack.",
    "> Notes",
    "> - On 64-bit, replace EBP\u2192RBP and ESP\u2192RSP. Semantics are the same.",
    "> - Some compilers omit the frame pointer (see \u201cEBP might not be used\u201d). In that case, `leave` might not appear and this technique won\u2019t work.",
    "### EBP2Ret",
    "This technique is particularly useful when you can **alter the saved EBP/RBP but have no direct way to change EIP/RIP**. It leverages the function epilogue behavior.",
    "If, during `fvuln`'s execution, you manage to inject a **fake EBP** in the stack that points to an area in memory where your shellcode/ROP chain address is located (plus 8 bytes on amd64 / 4 bytes on x86 to account for the `pop`), you can indirectly control RIP. As the function returns, `leave` sets RSP to the crafted location and the subsequent `pop rbp` decreases RSP, **effectively making it point to an address stored by the attacker there**. Then `ret` will use that address.",
    "Note how you **need to know 2 addresses**: the address where ESP/RSP is going to go, and the value stored at that address that `ret` will consume."
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md"
  ]
}