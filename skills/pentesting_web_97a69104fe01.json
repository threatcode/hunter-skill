{
  "id": "pentesting_web_97a69104fe01",
  "category": "pentesting-web",
  "title": "bypassing sop with iframes 2",
  "description": "# Bypassing SOP with Iframes - 2\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Iframes in SOP-2\n\nIn the [**solution**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) for this [**challenge**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)**,** [**@Strellic\\_**](https://twitter.com/Strellic_) proposes a similar method to the previous section. Let's check it.\n\nIn this challenge the attacker needs to **bypass** t",
  "payloads": [
    "# Bypassing SOP with Iframes - 2",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Iframes in SOP-2",
    "In the [**solution**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) for this [**challenge**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)**,** [**@Strellic\\_**](https://twitter.com/Strellic_) proposes a similar method to the previous section. Let's check it.",
    "In this challenge the attacker needs to **bypass** this:",
    "```javascript",
    "if (e.source == window.calc.contentWindow && e.data.token == window.token) {",
    "If he does, he can send a **postmessage** with HTML content that is going to be written in the page with **`innerHTML`** without sanitation (**XSS**).",
    "The way to bypass the **first check** is by making **`window.calc.contentWindow`** to **`undefined`** and **`e.source`** to **`null`**:",
    "- **`window.calc.contentWindow`** is actually **`document.getElementById(\"calc\")`**. You can clobber **`document.getElementById`** with **`<img name=getElementById />`** (note that Sanitizer API -[here](https://wicg.github.io/sanitizer-api/index.html#dom-clobbering)- is not configured to protect against DOM clobbering attacks in its default state).",
    "- Therefore, you can clobber **`document.getElementById(\"calc\")`** with **`<img name=getElementById /><div id=calc></div>`**. Then, **`window.calc`** will be **`undefined`**.",
    "- Now, we need **`e.source`** to be **`undefined`** or **`null`** (because `==` is used instead of `===`, **`null == undefined`** is **`True`**). Getting this is \"easy\". If you create an **iframe** and **send** a **postMessage** from it and immediately **remove** the iframe, **`e.origin`** is going to be **`null`**. Check the following code",
    "```javascript",
    "let iframe = document.createElement(\"iframe\")",
    "document.body.appendChild(iframe)"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/pentesting-web/postmessage-vulnerabilities/bypassing-sop-with-iframes-2.md"
  ]
}