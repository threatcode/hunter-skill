{
  "id": "binary_exploitation_015c156f20e7",
  "category": "binary-exploitation",
  "title": "CVE 2021 30807 IOMobileFrameBuffer",
  "description": "# CVE-2021-30807: IOMobileFrameBuffer OOB\n\n{{#include ../../banners/hacktricks-training.md}}\n\n\n## The Bug\n\nYou have a [great explanation of the vuln here](https://saaramar.github.io/IOMobileFrameBuffer_LPE_POC/), but as summary:\n\n- The vulnerable code path is **external method #83** of the **IOMobileFramebuffer / AppleCLCD** user client: `IOMobileFramebufferUserClient::s_displayed_fb_surface(...)`. This method receives a parameter controlled by the user that is not check in any way and that pass",
  "payloads": [
    "# CVE-2021-30807: IOMobileFrameBuffer OOB",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## The Bug",
    "You have a [great explanation of the vuln here](https://saaramar.github.io/IOMobileFrameBuffer_LPE_POC/), but as summary:",
    "- The vulnerable code path is **external method #83** of the **IOMobileFramebuffer / AppleCLCD** user client: `IOMobileFramebufferUserClient::s_displayed_fb_surface(...)`. This method receives a parameter controlled by the user that is not check in any way and that passes to the next function as **`scalar0`**.",
    "- That method forwards into **`IOMobileFramebufferLegacy::get_displayed_surface(this, task*, out_id, scalar0)`**, where **`scalar0`** (a user-controlled **32-bit** value) is used as an **index** into an internal **array of pointers** without **any bounds check**:",
    "> `ptr = *(this + 0xA58 + scalar0 * 8);` \u2192 passed to `IOSurfaceRoot::copyPortNameForSurfaceInTask(...)` as an **`IOSurface*`**.\\",
    "> **Result:** **OOB pointer read & type confusion** on that array. If the pointer isn't valid, the kernel deref panics \u2192 **DoS**.",
    "> [!NOTE]",
    "> This was fixed in **iOS/iPadOS 14.7.1**, **macOS Big Sur 11.5.1**, **watchOS 7.6.1**",
    "> [!WARNING]",
    "> The initial function to call `IOMobileFramebufferUserClient::s_displayed_fb_surface(...)` is protected by the entitlement **`com.apple.private.allow-explicit-graphics-priority`**. However, **WebKit.WebContent** has this entitlement, so it can be used to trigger the vuln from a sandboxed process.",
    "## DoS PoC",
    "The following is the initial DoS PoC from the ooriginal blog post with extra comments:",
    "// PoC for CVE-2021-30807 trigger (annotated)"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/ios-exploiting/CVE-2021-30807-IOMobileFrameBuffer.md"
  ]
}