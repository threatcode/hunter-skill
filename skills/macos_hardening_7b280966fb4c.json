{
  "id": "macos_hardening_7b280966fb4c",
  "category": "macos-hardening",
  "title": "macos office sandbox bypasses",
  "description": "# macOS Office Sandbox Bypasses\n\n{{#include ../../../../../banners/hacktricks-training.md}}\n\n### Word Sandbox bypass via Launch Agents\n\nThe application uses a **custom Sandbox** using the entitlement **`com.apple.security.temporary-exception.sbpl`** and this custom sandbox allows to write files anywhere as long as the filename started with `~$`: `(require-any (require-all (vnode-type REGULAR-FILE) (regex #\"(^|/)~$[^/]+$\")))`\n\nTherefore, escaping was as easy as **writing a `plist`** LaunchAgent i",
  "payloads": [
    "# macOS Office Sandbox Bypasses",
    "{{#include ../../../../../banners/hacktricks-training.md}}",
    "### Word Sandbox bypass via Launch Agents",
    "The application uses a **custom Sandbox** using the entitlement **`com.apple.security.temporary-exception.sbpl`** and this custom sandbox allows to write files anywhere as long as the filename started with `~$`: `(require-any (require-all (vnode-type REGULAR-FILE) (regex #\"(^|/)~$[^/]+$\")))`",
    "Therefore, escaping was as easy as **writing a `plist`** LaunchAgent in `~/Library/LaunchAgents/~$escape.plist`.",
    "Check the [**original report here**](https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/).",
    "### Word Sandbox bypass via Login Items and zip",
    "Remember that from the first escape, Word can write arbitrary files whose name start with `~$` although after the patch of the previous vuln it wasn't possible to write in `/Library/Application Scripts` or in `/Library/LaunchAgents`.",
    "It was discovered that from within the sandbox it's possible to create a **Login Item** (apps that will be executed when the user logs in). However, these apps **won't execute unless** they are **notarized** and it's **not possible to add args** (so you cannot just run a reverse shell using **`bash`**).",
    "From the previous Sandbox bypass, Microsoft disabled the option to write files in `~/Library/LaunchAgents`. However, it was discovered that if you put a **zip file as a Login Item** the `Archive Utility` will just **unzip** it on its current location. So, because by default the folder `LaunchAgents` from `~/Library` is not created, it was possible to **zip a plist in `LaunchAgents/~$escape.plist`** and **place** the zip file in **`~/Library`** so when decompress it will reach the persistence destination.",
    "Check the [**original report here**](https://objective-see.org/blog/blog_0x4B.html).",
    "### Word Sandbox bypass via Login Items and .zshenv",
    "(Remember that from the first escape, Word can write arbitrary files whose name start with `~$`).",
    "However, the previous technique had a limitation, if the folder **`~/Library/LaunchAgents`** exists because some other software created it, it would fail. So a different Login Items chain was discovered for this.",
    "An attacker could create the the files **`.bash_profile`** and **`.zshenv`** with the payload to execute and then zip them and **write the zip in the victims** user folder: **`~/~$escape.zip`**."
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-sandbox/macos-sandbox-debug-and-bypass/macos-office-sandbox-bypasses.md"
  ]
}