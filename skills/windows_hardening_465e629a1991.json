{
  "id": "windows_hardening_465e629a1991",
  "category": "windows-hardening",
  "title": "sedebug + seimpersonate copy token",
  "description": "# SeDebug + SeImpersonate - Copy Token\n\n{{#include ../../banners/hacktricks-training.md}}\n\nThe following code **exploits the privileges SeDebug and SeImpersonate** to copy the token from a **process running as SYSTEM** and with **all the token privileges**. \\\nIn this case, this code can be compiled and used as a **Windows service binary** to check that it's working.\\\nHowever, the main part of the **code where the elevation occurs** is inside the **`Exploit`** **function**.\\\nInside of that functi",
  "payloads": [
    "# SeDebug + SeImpersonate - Copy Token",
    "{{#include ../../banners/hacktricks-training.md}}",
    "The following code **exploits the privileges SeDebug and SeImpersonate** to copy the token from a **process running as SYSTEM** and with **all the token privileges**. \\",
    "In this case, this code can be compiled and used as a **Windows service binary** to check that it's working.\\",
    "However, the main part of the **code where the elevation occurs** is inside the **`Exploit`** **function**.\\",
    "Inside of that function you can see that the **process **_**lsass.exe**_** is searched**, then it's **token is copied**, and finally that token is used to spawn a new _**cmd.exe**_ with all the privileges of the copied token.",
    "**Other processes** running as SYSTEM with all or most of the token privileges are: **services.exe**, **svhost.exe** (on of the firsts ones), **wininit.exe**, **csrss.exe**... (_remember that you won't be able to copy a token from a Protected process_). Moreover, you can use the tool [Process Hacker](https://processhacker.sourceforge.io/downloads.php) running as administrator to see the tokens of a process.",
    "// From https://cboard.cprogramming.com/windows-programming/106768-running-my-program-service.html",
    "#include <windows.h>",
    "#include <tlhelp32.h>",
    "#include <tchar.h>",
    "#pragma comment (lib, \"advapi32\")",
    "TCHAR* serviceName = TEXT(\"TokenDanceSrv\");",
    "SERVICE_STATUS serviceStatus;",
    "SERVICE_STATUS_HANDLE serviceStatusHandle = 0;"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/windows-hardening/windows-local-privilege-escalation/sedebug-+-seimpersonate-copy-token.md"
  ]
}