{
  "id": "binary_exploitation_e635f161fea6",
  "category": "binary-exploitation",
  "title": "www2exec atexit",
  "description": "# WWW2Exec - atexit(), TLS Storage & Other mangled Pointers\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## **\\_\\_atexit Structures**\n\n> [!CAUTION]\n> Nowadays is very **weird to exploit this!**\n\n**`atexit()`** is a function to which **other functions are passed as parameters.** These **functions** will be **executed** when executing an **`exit()`** or the **return** of the **main**.\\\nIf you can **modify** the **address** of any of these **functions** to point to a shellcode for example, y",
  "payloads": [
    "# WWW2Exec - atexit(), TLS Storage & Other mangled Pointers",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## **\\_\\_atexit Structures**",
    "> [!CAUTION]",
    "> Nowadays is very **weird to exploit this!**",
    "**`atexit()`** is a function to which **other functions are passed as parameters.** These **functions** will be **executed** when executing an **`exit()`** or the **return** of the **main**.\\",
    "If you can **modify** the **address** of any of these **functions** to point to a shellcode for example, you will **gain control** of the **process**, but this is currently more complicated.\\",
    "Currently the **addresses to the functions** to be executed are **hidden** behind several structures and finally the address to which it points are not the addresses of the functions, but are **encrypted with XOR** and displacements with a **random key**. So currently this attack vector is **not very useful at least on x86** and **x64_86**.\\",
    "The **encryption function** is **`PTR_MANGLE`**. **Other architectures** such as m68k, mips32, mips64, aarch64, arm, hppa... **do not implement the encryption** function because it **returns the same** as it received as input. So these architectures would be attackable by this vector.",
    "You can find an in depth explanation on how this works in [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html)",
    "## link_map",
    "As explained [**in this post**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link_map-structure), If the program exits using `return` or `exit()` it'll run `__run_exit_handlers()` which will call registered destructors.",
    "> [!CAUTION]",
    "> If the program exits via **`_exit()`** function, it'll call the **`exit` syscall** and the exit handlers will not be executed. So, to confirm `__run_exit_handlers()` is executed you can set a breakpoint on it.",
    "The important code is ([source](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/arbitrary-write-2-exec/www2exec-atexit.md"
  ]
}