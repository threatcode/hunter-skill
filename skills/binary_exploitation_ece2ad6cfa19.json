{
  "id": "binary_exploitation_ece2ad6cfa19",
  "category": "binary-exploitation",
  "title": "virtualbox slirp nat packet heap exploitation",
  "description": "# VirtualBox Slirp NAT Packet Heap Exploitation\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## TL;DR\n\n- VirtualBox ships a heavily modified fork of Slirp whose packet buffers (mbufs) live in a custom zone allocator with inline metadata and function-pointer callbacks (`pfFini`, `pfDtor`).\n- A guest can rewrite the trusted `m->m_len` with an attacker-controlled IP header length, which destroys all later bounds checks and yields both infoleak and overwrite primitives.\n- By abusing UDP packe",
  "payloads": [
    "# VirtualBox Slirp NAT Packet Heap Exploitation",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## TL;DR",
    "- VirtualBox ships a heavily modified fork of Slirp whose packet buffers (mbufs) live in a custom zone allocator with inline metadata and function-pointer callbacks (`pfFini`, `pfDtor`).",
    "- A guest can rewrite the trusted `m->m_len` with an attacker-controlled IP header length, which destroys all later bounds checks and yields both infoleak and overwrite primitives.",
    "- By abusing UDP packets with checksum `0` and oversized `ip_len`, the guest can exfiltrate mbuf tails and the metadata of neighbouring chunks to learn heap and zone addresses.",
    "- Providing crafted IP options forces `ip_stripoptions()` to `memcpy()` too much data in-place, so the attacker can overwrite the next mbuf's `struct item` header and point its `zone` field at fully controlled data.",
    "- Freeing the corrupted mbuf triggers `zone->pfFini()` with attacker-supplied arguments; pointing it to `memcpy@plt` gives an arbitrary copy/write primitive that can be steered toward GOT entries or other control data inside the non-PIE VirtualBox binary.",
    "## Packet allocator anatomy",
    "VirtualBox allocates every ingress Ethernet frame from a per-interface zone named `zone_clust`. Each 0x800-byte data chunk is preceded by an inline header:",
    "struct item {",
    "uint32_t magic;      // 0xdead0001",
    "void    *zone;       // uma_zone_t pointer with callbacks",
    "uint32_t ref_count;",
    "LIST_ENTRY(item) list; // freelist / used list links"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/binary-exploitation/libc-heap/virtualbox-slirp-nat-packet-heap-exploitation.md"
  ]
}