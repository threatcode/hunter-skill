{
  "id": "windows_hardening_5408e6f19bd4",
  "category": "windows-hardening",
  "title": "constrained delegation",
  "description": "# Constrained Delegation\n\n{{#include ../../banners/hacktricks-training.md}}\n\n## Constrained Delegation\n\nUsing this a Domain admin can **allow** a computer to **impersonate a user or computer** against any **service** of a machine.\n\n- **Service for User to self (_S4U2self_):** If a **service account** has a _userAccountControl_ value containing [TrustedToAuthForDelegation](<https://msdn.microsoft.com/en-us/library/aa772300(v=vs.85).aspx>) (T2A4D), then it can obtain a TGS for itself (the service)",
  "payloads": [
    "# Constrained Delegation",
    "{{#include ../../banners/hacktricks-training.md}}",
    "## Constrained Delegation",
    "Using this a Domain admin can **allow** a computer to **impersonate a user or computer** against any **service** of a machine.",
    "- **Service for User to self (_S4U2self_):** If a **service account** has a _userAccountControl_ value containing [TrustedToAuthForDelegation](<https://msdn.microsoft.com/en-us/library/aa772300(v=vs.85).aspx>) (T2A4D), then it can obtain a TGS for itself (the service) on behalf of any other user.",
    "- **Service for User to Proxy(_S4U2proxy_):** A **service account** could obtain a TGS on behalf any user to the service set in **msDS-AllowedToDelegateTo.** To do so, it first need a TGS from that user to itself, but it can use S4U2self to obtain that TGS before requesting the other one.",
    "**Note**: If a user is marked as \u2018_Account is sensitive and cannot be delegated_ \u2019 in AD, you will **not be able to impersonate** them.",
    "This means that if you **compromise the hash of the service** you can **impersonate users** and obtain **access** on their behalf to any **service** over the indicated machines (possible **privesc**).",
    "Moreover, you **won't only have access to the service that the user is able to impersonate, but also to any service** because the SPN (the service name requested) is not being checked (in the ticket this part is not encrypted/signed). Therefore, if you have access to **CIFS service** you can also have access to **HOST service** using `/altservice` flag in Rubeus for example. The same SPN swapping weakness is abused by **Impacket getST -altservice** and other tooling.",
    "Also, **LDAP service access on DC**, is what is needed to exploit a **DCSync**.",
    "```bash:Enumerate",
    "# Powerview",
    "Get-DomainUser -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto",
    "Get-DomainComputer -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto",
    "#ADSearch"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/windows-hardening/active-directory-methodology/constrained-delegation.md"
  ]
}