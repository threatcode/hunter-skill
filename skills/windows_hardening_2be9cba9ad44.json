{
  "id": "windows_hardening_2be9cba9ad44",
  "category": "windows-hardening",
  "title": "telephony tapsrv arbitrary dword write to rce",
  "description": "# Telephony tapsrv Arbitrary DWORD Write to RCE (TAPI Server Mode)\n\n{{#include ../../banners/hacktricks-training.md}}\n\nWhen the Windows Telephony service (TapiSrv, `tapisrv.dll`) is configured as a **TAPI server**, it exposes the **`tapsrv` MSRPC interface over the `\\pipe\\tapsrv` named pipe** to authenticated SMB clients. A design bug in the asynchronous event delivery for remote clients lets an attacker turn a mailslot handle into a **controlled 4-byte write to any pre-existing file writable by",
  "payloads": [
    "# Telephony tapsrv Arbitrary DWORD Write to RCE (TAPI Server Mode)",
    "{{#include ../../banners/hacktricks-training.md}}",
    "When the Windows Telephony service (TapiSrv, `tapisrv.dll`) is configured as a **TAPI server**, it exposes the **`tapsrv` MSRPC interface over the `\\pipe\\tapsrv` named pipe** to authenticated SMB clients. A design bug in the asynchronous event delivery for remote clients lets an attacker turn a mailslot handle into a **controlled 4-byte write to any pre-existing file writable by `NETWORK SERVICE`**. That primitive can be chained to overwrite the Telephony admin list and abuse an **admin-only arbitrary DLL load** to execute code as `NETWORK SERVICE`.",
    "## Attack Surface",
    "- **Remote exposure only when enabled**: `HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Telephony\\Server\\DisableSharing` must allow sharing (or configured via `TapiMgmt.msc` / `tcmsetup /c <server>`). By default `tapsrv` is local-only.",
    "- Interface: MS-TRP (`tapsrv`) over **SMB named pipe**, so the attacker needs valid SMB auth.",
    "- Service account: `NETWORK SERVICE` (manual start, on-demand).",
    "## Primitive: Mailslot Path Confusion \u2192 Arbitrary DWORD Write",
    "- `ClientAttach(pszDomainUser, pszMachine, ...)` initializes async event delivery. In pull mode, the service does:",
    "CreateFileW(pszDomainUser, GENERIC_WRITE, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);",
    "without validating that `pszDomainUser` is a mailslot path (`\\\\*\\MAILSLOT\\...`). Any **existing filesystem path** writable by `NETWORK SERVICE` is accepted.",
    "- Every async event write stores a single **`DWORD` = `InitContext`** (attacker-controlled in the subsequent `Initialize` request) to the opened handle, yielding **write-what/write-where (4 bytes)**.",
    "## Forcing Deterministic Writes",
    "1. **Open target file**: `ClientAttach` with `pszDomainUser = <existing writable path>` (e.g., `C:\\Windows\\TAPI\\tsec.ini`).",
    "2. For each `DWORD` to write, execute this RPC sequence against `ClientRequest`:"
  ],
  "source": "HackTricks",
  "references": [
    "/workspaces/hunter-skill/hacktricks/src/windows-hardening/windows-local-privilege-escalation/telephony-tapsrv-arbitrary-dword-write-to-rce.md"
  ]
}